<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<section xmlns="http://docbook.org/ns/docbook" version="5.0" xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="_servo_8cpp_source" xml:lang="zh">
<title>servo.cpp</title>
<indexterm><primary>HW-Components/devices/servo/src/servo.cpp</primary></indexterm>
浏览该文件的文档.<programlisting linenumbering="unnumbered"><anchor xml:id="_servo_8cpp_source_1l00001"/>00001 
<anchor xml:id="_servo_8cpp_source_1l00015"/>00015 <emphasis role="comment">/*&#32;Includes&#32;------------------------------------------------------------------*/</emphasis>
<anchor xml:id="_servo_8cpp_source_1l00016"/>00016 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_servo_8hpp">servo.hpp</link>&quot;</emphasis>
<anchor xml:id="_servo_8cpp_source_1l00017"/>00017 
<anchor xml:id="_servo_8cpp_source_1l00018"/>00018 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_assert_8hpp">assert.hpp</link>&quot;</emphasis>
<anchor xml:id="_servo_8cpp_source_1l00019"/>00019 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_base_8hpp">base.hpp</link>&quot;</emphasis>
<anchor xml:id="_servo_8cpp_source_1l00020"/>00020 
<anchor xml:id="_servo_8cpp_source_1l00021"/>00021 <emphasis role="keyword">namespace&#32;</emphasis><link linkend="_namespacehello__world">hello_world</link>
<anchor xml:id="_servo_8cpp_source_1l00022"/>00022 {
<anchor xml:id="_servo_8cpp_source_1l00023"/>00023 <emphasis role="keyword">namespace&#32;</emphasis>devices
<anchor xml:id="_servo_8cpp_source_1l00024"/>00024 {
<anchor xml:id="_servo_8cpp_source_1l00025"/>00025 <emphasis role="keyword">namespace&#32;</emphasis>servo
<anchor xml:id="_servo_8cpp_source_1l00026"/>00026 {
<anchor xml:id="_servo_8cpp_source_1l00027"/>00027 <emphasis role="comment">/*&#32;Private&#32;macro&#32;-------------------------------------------------------------*/</emphasis>
<anchor xml:id="_servo_8cpp_source_1l00028"/>00028 <emphasis role="comment">/*&#32;Private&#32;constants&#32;---------------------------------------------------------*/</emphasis>
<anchor xml:id="_servo_8cpp_source_1l00029"/><link linkend="_namespacehello__world_1_1devices_1_1servo_1acf98bb6ad42e7b0af3468625dc880035">00029</link> <emphasis role="keyword">static</emphasis>&#32;<emphasis role="keyword">const</emphasis>&#32;<emphasis role="keywordtype">float</emphasis>&#32;<link linkend="_namespacehello__world_1_1devices_1_1servo_1acf98bb6ad42e7b0af3468625dc880035">kTimerFreq</link>&#32;=&#32;1e6f;
<anchor xml:id="_servo_8cpp_source_1l00030"/>00030 <emphasis role="comment">/*&#32;Private&#32;types&#32;-------------------------------------------------------------*/</emphasis>
<anchor xml:id="_servo_8cpp_source_1l00031"/>00031 <emphasis role="comment">/*&#32;Private&#32;variables&#32;---------------------------------------------------------*/</emphasis>
<anchor xml:id="_servo_8cpp_source_1l00032"/>00032 <emphasis role="comment">/*&#32;External&#32;variables&#32;--------------------------------------------------------*/</emphasis>
<anchor xml:id="_servo_8cpp_source_1l00033"/>00033 <emphasis role="comment">/*&#32;Private&#32;function&#32;prototypes&#32;-----------------------------------------------*/</emphasis>
<anchor xml:id="_servo_8cpp_source_1l00034"/>00034 
<anchor xml:id="_servo_8cpp_source_1l00045"/><link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1a538666221be8aebbd757061a57203e56">00045</link> <link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1a538666221be8aebbd757061a57203e56">Servo::Servo</link>(TIM_HandleTypeDef*&#32;htim,&#32;uint32_t&#32;channel,
<anchor xml:id="_servo_8cpp_source_1l00046"/>00046 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keyword">const</emphasis>&#32;<link linkend="_structhello__world_1_1devices_1_1servo_1_1_servo_info">ServoInfo</link>&amp;&#32;servo_info,&#32;<emphasis role="keywordtype">float</emphasis>&#32;init_angle)
<anchor xml:id="_servo_8cpp_source_1l00047"/>00047 &#32;&#32;&#32;&#32;:&#32;kHtim_(htim),&#32;kChannel_(channel),&#32;kServoInfo_(servo_info)
<anchor xml:id="_servo_8cpp_source_1l00048"/>00048 {
<anchor xml:id="_servo_8cpp_source_1l00049"/>00049 &#32;&#32;<emphasis role="comment">/*&#32;变量检查&#32;*/</emphasis>
<anchor xml:id="_servo_8cpp_source_1l00050"/>00050 <emphasis role="preprocessor">#pragma&#32;region</emphasis>
<anchor xml:id="_servo_8cpp_source_1l00051"/>00051 &#32;&#32;<link linkend="_assert_8hpp_1a5969df827ceb603bed14c4106586484a">HW_ASSERT</link>(IS_TIM_INSTANCE(<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1ab09397483f5eb4ac6f879dbaa00407f2">kHtim_</link>-&gt;Instance),&#32;<emphasis role="stringliteral">&quot;Error&#32;TIM&#32;handle&quot;</emphasis>);
<anchor xml:id="_servo_8cpp_source_1l00052"/>00052 &#32;&#32;<link linkend="_assert_8hpp_1a5969df827ceb603bed14c4106586484a">HW_ASSERT</link>(IS_TIM_CHANNELS(<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1af7138e8cec740393fc793674d9ac23f2">kChannel_</link>),&#32;<emphasis role="stringliteral">&quot;Error&#32;TIM&#32;channel:&#32;%d&quot;</emphasis>,&#32;<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1af7138e8cec740393fc793674d9ac23f2">kChannel_</link>);
<anchor xml:id="_servo_8cpp_source_1l00053"/>00053 &#32;&#32;<link linkend="_assert_8hpp_1a5969df827ceb603bed14c4106586484a">HW_ASSERT</link>(<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1a970450231a2ce7b2057d8be915ffde22">kServoInfo_</link>.<link linkend="_structhello__world_1_1devices_1_1servo_1_1_servo_info_1a8909ce384f2bfc568b0d8de853441dfe">operating_freq</link>&#32;&gt;&#32;0,&#32;<emphasis role="stringliteral">&quot;Error&#32;Operating&#32;freqency:&#32;%.1f&quot;</emphasis>,
<anchor xml:id="_servo_8cpp_source_1l00054"/>00054 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1a970450231a2ce7b2057d8be915ffde22">kServoInfo_</link>.<link linkend="_structhello__world_1_1devices_1_1servo_1_1_servo_info_1a8909ce384f2bfc568b0d8de853441dfe">operating_freq</link>);
<anchor xml:id="_servo_8cpp_source_1l00055"/>00055 &#32;&#32;<link linkend="_assert_8hpp_1a5969df827ceb603bed14c4106586484a">HW_ASSERT</link>(<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1a970450231a2ce7b2057d8be915ffde22">kServoInfo_</link>.<link linkend="_structhello__world_1_1devices_1_1servo_1_1_servo_info_1a54283a2b415c5c18adceaf3ba4ebb40c">min_pulse_duration</link>&#32;&lt;&#32;<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1a970450231a2ce7b2057d8be915ffde22">kServoInfo_</link>.<link linkend="_structhello__world_1_1devices_1_1servo_1_1_servo_info_1a8a375675055ea690bd3b54674d25a23f">max_pulse_duration</link>&#32;&amp;&amp;
<anchor xml:id="_servo_8cpp_source_1l00056"/>00056 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1a970450231a2ce7b2057d8be915ffde22">kServoInfo_</link>.<link linkend="_structhello__world_1_1devices_1_1servo_1_1_servo_info_1a54283a2b415c5c18adceaf3ba4ebb40c">min_pulse_duration</link>&#32;&gt;&#32;0u&#32;&amp;&amp;
<anchor xml:id="_servo_8cpp_source_1l00057"/>00057 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1a970450231a2ce7b2057d8be915ffde22">kServoInfo_</link>.<link linkend="_structhello__world_1_1devices_1_1servo_1_1_servo_info_1a8a375675055ea690bd3b54674d25a23f">max_pulse_duration</link>&#32;&lt;
<anchor xml:id="_servo_8cpp_source_1l00058"/>00058 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keyword">static_cast&lt;</emphasis>uint16_t<emphasis role="keyword">&gt;</emphasis>(1e6f&#32;/&#32;<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1a970450231a2ce7b2057d8be915ffde22">kServoInfo_</link>.<link linkend="_structhello__world_1_1devices_1_1servo_1_1_servo_info_1a8909ce384f2bfc568b0d8de853441dfe">operating_freq</link>),
<anchor xml:id="_servo_8cpp_source_1l00059"/>00059 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="stringliteral">&quot;Error&#32;pulse&#32;duration&quot;</emphasis>);
<anchor xml:id="_servo_8cpp_source_1l00060"/>00060 &#32;&#32;<link linkend="_assert_8hpp_1a5969df827ceb603bed14c4106586484a">HW_ASSERT</link>(<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1a970450231a2ce7b2057d8be915ffde22">kServoInfo_</link>.<link linkend="_structhello__world_1_1devices_1_1servo_1_1_servo_info_1af9e22985d9ba75c434ad168ef8db8b73">angle_range</link>&#32;&lt;=&#32;360.0f,
<anchor xml:id="_servo_8cpp_source_1l00061"/>00061 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="stringliteral">&quot;Error&#32;angle&#32;range:&#32;%d&quot;</emphasis>,&#32;<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1a970450231a2ce7b2057d8be915ffde22">kServoInfo_</link>.<link linkend="_structhello__world_1_1devices_1_1servo_1_1_servo_info_1af9e22985d9ba75c434ad168ef8db8b73">angle_range</link>);
<anchor xml:id="_servo_8cpp_source_1l00062"/>00062 <emphasis role="preprocessor">#pragma&#32;endregion</emphasis>
<anchor xml:id="_servo_8cpp_source_1l00063"/>00063 
<anchor xml:id="_servo_8cpp_source_1l00064"/>00064 &#32;&#32;uint32_t&#32;auto_reload&#32;=
<anchor xml:id="_servo_8cpp_source_1l00065"/>00065 &#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keyword">static_cast&lt;</emphasis>uint32_t<emphasis role="keyword">&gt;</emphasis>(<link linkend="_namespacehello__world_1_1devices_1_1servo_1acf98bb6ad42e7b0af3468625dc880035">kTimerFreq</link>&#32;/&#32;<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1a970450231a2ce7b2057d8be915ffde22">kServoInfo_</link>.<link linkend="_structhello__world_1_1devices_1_1servo_1_1_servo_info_1a8909ce384f2bfc568b0d8de853441dfe">operating_freq</link>)&#32;-&#32;1;
<anchor xml:id="_servo_8cpp_source_1l00066"/>00066 &#32;&#32;__HAL_TIM_SET_AUTORELOAD(<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1ab09397483f5eb4ac6f879dbaa00407f2">kHtim_</link>,&#32;auto_reload);
<anchor xml:id="_servo_8cpp_source_1l00067"/>00067 &#32;&#32;__HAL_TIM_SET_COMPARE(<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1ab09397483f5eb4ac6f879dbaa00407f2">kHtim_</link>,&#32;<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1af7138e8cec740393fc793674d9ac23f2">kChannel_</link>,&#32;<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1af678b6d9c70e3be611755ac1ae233aa5">angle2Cmp</link>(init_angle));
<anchor xml:id="_servo_8cpp_source_1l00068"/>00068 &#32;&#32;HAL_TIM_PWM_Start(<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1ab09397483f5eb4ac6f879dbaa00407f2">kHtim_</link>,&#32;<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1af7138e8cec740393fc793674d9ac23f2">kChannel_</link>);
<anchor xml:id="_servo_8cpp_source_1l00069"/>00069 }
<anchor xml:id="_servo_8cpp_source_1l00070"/>00070 
<anchor xml:id="_servo_8cpp_source_1l00077"/><link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1a22fff12088bc63dc21cace008a5e1b35">00077</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1a22fff12088bc63dc21cace008a5e1b35">Servo::setAngle</link>(<emphasis role="keywordtype">float</emphasis>&#32;angle)<emphasis role="keyword">&#32;const</emphasis>
<anchor xml:id="_servo_8cpp_source_1l00078"/>00078 <emphasis role="keyword"></emphasis>{
<anchor xml:id="_servo_8cpp_source_1l00079"/>00079 &#32;&#32;__HAL_TIM_SET_COMPARE(<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1ab09397483f5eb4ac6f879dbaa00407f2">kHtim_</link>,&#32;<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1af7138e8cec740393fc793674d9ac23f2">kChannel_</link>,&#32;<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1af678b6d9c70e3be611755ac1ae233aa5">angle2Cmp</link>(angle));
<anchor xml:id="_servo_8cpp_source_1l00080"/>00080 }
<anchor xml:id="_servo_8cpp_source_1l00081"/>00081 
<anchor xml:id="_servo_8cpp_source_1l00088"/><link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1af678b6d9c70e3be611755ac1ae233aa5">00088</link> uint32_t&#32;<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1af678b6d9c70e3be611755ac1ae233aa5">Servo::angle2Cmp</link>(<emphasis role="keywordtype">float</emphasis>&#32;angle)<emphasis role="keyword">&#32;const</emphasis>
<anchor xml:id="_servo_8cpp_source_1l00089"/>00089 <emphasis role="keyword"></emphasis>{
<anchor xml:id="_servo_8cpp_source_1l00090"/>00090 &#32;&#32;angle&#32;=&#32;<link linkend="_namespacehello__world_1a34cb06299a34f746d556d23dc16904aa">Bound</link>(angle,&#32;0.0f,&#32;<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1a970450231a2ce7b2057d8be915ffde22">kServoInfo_</link>.<link linkend="_structhello__world_1_1devices_1_1servo_1_1_servo_info_1af9e22985d9ba75c434ad168ef8db8b73">angle_range</link>);
<anchor xml:id="_servo_8cpp_source_1l00091"/>00091 &#32;&#32;uint32_t&#32;cmp&#32;=&#32;<emphasis role="keyword">static_cast&lt;</emphasis>uint32_t<emphasis role="keyword">&gt;</emphasis>(
<anchor xml:id="_servo_8cpp_source_1l00092"/>00092 &#32;&#32;&#32;&#32;&#32;&#32;angle&#32;*
<anchor xml:id="_servo_8cpp_source_1l00093"/>00093 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;(<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1a970450231a2ce7b2057d8be915ffde22">kServoInfo_</link>.<link linkend="_structhello__world_1_1devices_1_1servo_1_1_servo_info_1a8a375675055ea690bd3b54674d25a23f">max_pulse_duration</link>&#32;-&#32;<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1a970450231a2ce7b2057d8be915ffde22">kServoInfo_</link>.<link linkend="_structhello__world_1_1devices_1_1servo_1_1_servo_info_1a54283a2b415c5c18adceaf3ba4ebb40c">min_pulse_duration</link>)&#32;/
<anchor xml:id="_servo_8cpp_source_1l00094"/>00094 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1a970450231a2ce7b2057d8be915ffde22">kServoInfo_</link>.<link linkend="_structhello__world_1_1devices_1_1servo_1_1_servo_info_1af9e22985d9ba75c434ad168ef8db8b73">angle_range</link>&#32;+
<anchor xml:id="_servo_8cpp_source_1l00095"/>00095 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_classhello__world_1_1devices_1_1servo_1_1_servo_1a970450231a2ce7b2057d8be915ffde22">kServoInfo_</link>.<link linkend="_structhello__world_1_1devices_1_1servo_1_1_servo_info_1a54283a2b415c5c18adceaf3ba4ebb40c">min_pulse_duration</link>);
<anchor xml:id="_servo_8cpp_source_1l00096"/>00096 
<anchor xml:id="_servo_8cpp_source_1l00097"/>00097 &#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;cmp;
<anchor xml:id="_servo_8cpp_source_1l00098"/>00098 }
<anchor xml:id="_servo_8cpp_source_1l00099"/>00099 }&#32;&#32;<emphasis role="comment">//&#32;namespace&#32;servo</emphasis>
<anchor xml:id="_servo_8cpp_source_1l00100"/>00100 }&#32;&#32;<emphasis role="comment">//&#32;namespace&#32;devices</emphasis>
<anchor xml:id="_servo_8cpp_source_1l00101"/>00101 }&#32;&#32;<emphasis role="comment">//&#32;namespace&#32;hello_world</emphasis>
</programlisting></section>
